C251 COMPILER V5.60.0,  main                                                               24/07/23  16:40:13  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\main.obj
COMPILER INVOKED BY: D:\keil\C251\BIN\C251.EXE ..\src\main.c XSMALL INTR2 BROWSE INCDIR(..\inc) DEBUG PRINT(.\main.lst) 
                    -TABS(2) OBJECT(.\main.obj) 

stmt  level    source

    1          
    2          
    3          #include "STC32G.h"
    4          
    5          #include "stdio.h"
    6          #include "intrins.h"
    7          
    8          typedef   unsigned char u8;
    9          typedef   unsigned int  u16;
   10          typedef   unsigned long u32;
   11          
   12          #define MAIN_Fosc        22118400L   //¶¨ÒåÖ÷Ê±ÖÓ£¨¾«È·¼ÆËã115200²¨ÌØÂÊ£©
   13          
   14          //==========================================================================
   15          
   16          #define Baudrate1   (65536 - MAIN_Fosc / 115200 / 4)
   17          
   18          #define UART1_BUF_LENGTH    128
   19          
   20          //==========================================================================
   21          
   22          /*************  ±¾µØ³£Á¿ÉùÃ÷    **************/
   23          
   24          
   25          /*************  IO¿Ú¶¨Òå    **************/
   26          
   27          /*************  ±¾µØ±äÁ¿ÉùÃ÷    **************/
   28          
   29          u8  TX1_Cnt;    //·¢ËÍ¼ÆÊý
   30          u8  RX1_Cnt;    //½ÓÊÕ¼ÆÊý
   31          bit B_TX1_Busy; //·¢ËÍÃ¦±êÖ¾
   32          
   33          u8  RX1_Buffer[UART1_BUF_LENGTH]; //½ÓÊÕ»º³å
   34          
   35          /*************  ±¾µØº¯ÊýÉùÃ÷    **************/
   36          
   37          void UART1_config(u8 brt);   // Ñ¡Ôñ²¨ÌØÂÊ, 2: Ê¹ÓÃTimer2×ö²¨ÌØÂÊ, ÆäËüÖµ: Ê¹ÓÃTimer1×ö²¨ÌØÂÊ.
   38          void PrintString1(u8 *puts);
   39          
   40          /****************  Íâ²¿º¯ÊýÉùÃ÷ºÍÍâ²¿±äÁ¿ÉùÃ÷ *****************/
   41          
   42          
   43          /******************** Ö÷º¯Êý **************************/
   44          void main(void)
   45          {
   46   1          WTST = 0;  //ÉèÖÃ³ÌÐòÖ¸ÁîÑÓÊ±²ÎÊý£¬¸³ÖµÎª0¿É½«CPUÖ´ÐÐÖ¸ÁîµÄËÙ¶ÈÉèÖÃÎª×î¿ì
   47   1          EAXFR = 1; //À©Õ¹¼Ä´æÆ÷(XFR)·ÃÎÊÊ¹ÄÜ
   48   1          CKCON = 0; //Ìá¸ß·ÃÎÊXRAMËÙ¶È
   49   1      
   50   1          P0M1 = 0x30;   P0M0 = 0x30;   //ÉèÖÃP0.4¡¢P0.5ÎªÂ©¼«¿ªÂ·(ÊµÑéÏä¼ÓÁËÉÏÀ­µç×èµ½3.3V)
   51   1          P1M1 = 0x30;   P1M0 = 0x30;   //ÉèÖÃP1.4¡¢P1.5ÎªÂ©¼«¿ªÂ·(ÊµÑéÏä¼ÓÁËÉÏÀ­µç×èµ½3.3V)
   52   1          P2M1 = 0x3c;   P2M0 = 0x3c;   //ÉèÖÃP2.2~P2.5ÎªÂ©¼«¿ªÂ·(ÊµÑéÏä¼ÓÁËÉÏÀ­µç×èµ½3.3V)
   53   1          P3M1 = 0x50;   P3M0 = 0x50;   //ÉèÖÃP3.4¡¢P3.6ÎªÂ©¼«¿ªÂ·(ÊµÑéÏä¼ÓÁËÉÏÀ­µç×èµ½3.3V)
   54   1          P4M1 = 0x3c;   P4M0 = 0x3c;   //ÉèÖÃP4.2~P4.5ÎªÂ©¼«¿ªÂ·(ÊµÑéÏä¼ÓÁËÉÏÀ­µç×èµ½3.3V)
   55   1          P5M1 = 0x0c;   P5M0 = 0x0c;   //ÉèÖÃP5.2¡¢P5.3ÎªÂ©¼«¿ªÂ·(ÊµÑéÏä¼ÓÁËÉÏÀ­µç×èµ½3.3V)
   56   1          P6M1 = 0xff;   P6M0 = 0xff;   //ÉèÖÃÎªÂ©¼«¿ªÂ·(ÊµÑéÏä¼ÓÁËÉÏÀ­µç×èµ½3.3V)
   57   1          P7M1 = 0x00;   P7M0 = 0x00;   //ÉèÖÃÎª×¼Ë«Ïò¿Ú
   58   1      
C251 COMPILER V5.60.0,  main                                                               24/07/23  16:40:13  PAGE 2   

   59   1          UART1_config(2);    // Ñ¡Ôñ²¨ÌØÂÊ, 2: Ê¹ÓÃTimer2×ö²¨ÌØÂÊ, ÆäËüÖµ: Ê¹ÓÃTimer1×ö²¨ÌØÂÊ.
   60   1          EA = 1;             //ÔÊÐíÈ«¾ÖÖÐ¶Ï
   61   1      
   62   1          PrintString1("STC32G UART1 Test Programme!\r\n");  //UART1·¢ËÍÒ»¸ö×Ö·û´®
   63   1      
   64   1          while (1)
   65   1          {
   66   2              if((TX1_Cnt != RX1_Cnt) && (!B_TX1_Busy))   //ÊÕµ½Êý¾Ý, ·¢ËÍ¿ÕÏÐ
   67   2              {
   68   3                  SBUF = RX1_Buffer[TX1_Cnt];
   69   3                  B_TX1_Busy = 1;
   70   3                  if(++TX1_Cnt >= UART1_BUF_LENGTH)   TX1_Cnt = 0;
   71   3              }
   72   2          }
   73   1      }
   74          
   75          //========================================================================
   76          // º¯Êý: void PrintString1(u8 *puts)
   77          // ÃèÊö: ´®¿Ú1·¢ËÍ×Ö·û´®º¯Êý¡£
   78          // ²ÎÊý: puts:  ×Ö·û´®Ö¸Õë.
   79          // ·µ»Ø: none.
   80          // °æ±¾: VER1.0
   81          // ÈÕÆÚ: 2014-11-28
   82          // ±¸×¢: 
   83          //========================================================================
   84          void PrintString1(u8 *puts)
   85          {
   86   1          for (; *puts != 0;  puts++)     //Óöµ½Í£Ö¹·û0½áÊø
   87   1          {
   88   2              SBUF = *puts;
   89   2              B_TX1_Busy = 1;
   90   2              while(B_TX1_Busy);
   91   2          }
   92   1      }
   93          
   94          //========================================================================
   95          // º¯Êý: SetTimer2Baudraye(u32 dat)
   96          // ÃèÊö: ÉèÖÃTimer2×ö²¨ÌØÂÊ·¢ÉúÆ÷¡£
   97          // ²ÎÊý: dat: Timer2µÄÖØ×°Öµ.
   98          // ·µ»Ø: none.
   99          // °æ±¾: VER1.0
  100          // ÈÕÆÚ: 2014-11-28
  101          // ±¸×¢: 
  102          //========================================================================
  103          void SetTimer2Baudraye(u32 dat)
  104          {
  105   1          T2R = 0;    //Timer stop
  106   1          T2_CT = 0;  //Timer2 set As Timer
  107   1          T2x12 = 1;  //Timer2 set as 1T mode
  108   1          T2H = (u8)(dat / 256);
  109   1          T2L = (u8)(dat % 256);
  110   1          ET2 = 0;    //½ûÖ¹ÖÐ¶Ï
  111   1          T2R = 1;    //Timer run enable
  112   1      }
  113          
  114          //========================================================================
  115          // º¯Êý: void UART1_config(u8 brt)
  116          // ÃèÊö: UART1³õÊ¼»¯º¯Êý¡£
  117          // ²ÎÊý: brt: Ñ¡Ôñ²¨ÌØÂÊ, 2: Ê¹ÓÃTimer2×ö²¨ÌØÂÊ, ÆäËüÖµ: Ê¹ÓÃTimer1×ö²¨ÌØÂÊ.
  118          // ·µ»Ø: none.
  119          // °æ±¾: VER1.0
  120          // ÈÕÆÚ: 2014-11-28
  121          // ±¸×¢: 
  122          //========================================================================
  123          void UART1_config(u8 brt)
  124          {
C251 COMPILER V5.60.0,  main                                                               24/07/23  16:40:13  PAGE 3   

  125   1          /*********** ²¨ÌØÂÊÊ¹ÓÃ¶¨Ê±Æ÷2 *****************/
  126   1          if(brt == 2)
  127   1          {
  128   2              S1BRT = 1;  //S1 BRT Use Timer2;
  129   2              SetTimer2Baudraye(Baudrate1);
  130   2          }
  131   1      
  132   1          /*********** ²¨ÌØÂÊÊ¹ÓÃ¶¨Ê±Æ÷1 *****************/
  133   1          else
  134   1          {
  135   2              TR1 = 0;
  136   2              S1BRT = 0;    //S1 BRT Use Timer1;
  137   2              T1_CT = 0;    //Timer1 set As Timer
  138   2              T1x12 = 1;    //Timer1 set as 1T mode
  139   2              TMOD &= ~0x30;//Timer1_16bitAutoReload;
  140   2              TH1 = (u8)(Baudrate1 / 256);
  141   2              TL1 = (u8)(Baudrate1 % 256);
  142   2              ET1 = 0;    //½ûÖ¹ÖÐ¶Ï
  143   2              TR1 = 1;
  144   2          }
  145   1          /*************************************************/
  146   1      
  147   1          SCON = (SCON & 0x3f) | 0x40;    //UART1Ä£Ê½, 0x00: Í¬²½ÒÆÎ»Êä³ö, 0x40: 8Î»Êý¾Ý,¿É±ä²¨ÌØÂÊ, 0x80: 9Î»Ê
             -ý¾Ý,¹Ì¶¨²¨ÌØÂÊ, 0xc0: 9Î»Êý¾Ý,¿É±ä²¨ÌØÂÊ
  148   1      //  PS  = 1;    //¸ßÓÅÏÈ¼¶ÖÐ¶Ï
  149   1          ES  = 1;    //ÔÊÐíÖÐ¶Ï
  150   1          REN = 1;    //ÔÊÐí½ÓÊÕ
  151   1          P_SW1 &= 0x3f;
  152   1      //  P_SW1 |= 0x00;      //UART1 switch to, 0x00: P3.0 P3.1, 0x40: P3.6 P3.7, 0x80: P1.6 P1.7, 0xC0: P4.3 
             -P4.4
  153   1      
  154   1          B_TX1_Busy = 0;
  155   1          TX1_Cnt = 0;
  156   1          RX1_Cnt = 0;
  157   1      }
  158          
  159          
  160          //========================================================================
  161          // º¯Êý: void UART1_int (void) interrupt UART1_VECTOR
  162          // ÃèÊö: UART1ÖÐ¶Ïº¯Êý¡£
  163          // ²ÎÊý: nine.
  164          // ·µ»Ø: none.
  165          // °æ±¾: VER1.0
  166          // ÈÕÆÚ: 2014-11-28
  167          // ±¸×¢: 
  168          //========================================================================
  169          void UART1_int (void) interrupt 4
  170          {
  171   1          if(RI)
  172   1          {
  173   2              RI = 0;
  174   2              RX1_Buffer[RX1_Cnt] = SBUF;
  175   2              if(++RX1_Cnt >= UART1_BUF_LENGTH)   RX1_Cnt = 0;
  176   2          }
  177   1      
  178   1          if(TI)
  179   1          {
  180   2              TI = 0;
  181   2              B_TX1_Busy = 0;
  182   2          }
  183   1      }
  184          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       286     ------
C251 COMPILER V5.60.0,  main                                                               24/07/23  16:40:13  PAGE 4   

  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       130     ------
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        31     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
